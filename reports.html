<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отчеты - Система управления заказами</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .reports-grid {
            display: grid;
            gap: 20px;
        }

        .report-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f2f6;
        }

        .order-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-date {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .order-info {
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-label {
            font-weight: 600;
            color: #34495e;
            width: 120px;
            flex-shrink: 0;
        }

        .info-value {
            color: #2c3e50;
        }

        .current-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .progress-container {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .logistics-chain {
            margin-top: 20px;
        }

        .chain-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chain-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .chain-item.completed {
            background: #d5f4e6;
            color: #27ae60;
            border-left: 4px solid #27ae60;
        }

        .chain-item.current {
            background: #fef9e7;
            color: #f39c12;
            border-left: 4px solid #f39c12;
            font-weight: 600;
        }

        .chain-item.pending {
            background: #f8f9fa;
            color: #7f8c8d;
            border-left: 4px solid #ecf0f1;
        }

        .chain-icon {
            margin-right: 10px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .chain-text {
            flex: 1;
        }

        .chain-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-left: 10px;
        }

        .empty-reports {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            color: #7f8c8d;
        }

        .empty-reports .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-reports .text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .empty-reports .subtext {
            font-size: 1rem;
            opacity: 0.7;
        }

        /* Поиск в отчетах */
        .search-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-input-container {
            position: relative;
        }
        
        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 18px;
            pointer-events: none;
        }
        
        .clear-search {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* Вкладки отчетов */
        .report-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .report-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            background: transparent;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .report-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        
        /* Раздел проблем */
        .issues-section {
            margin-bottom: 30px;
        }
        
        .issue-item {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #e53e3e;
        }
        
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .issue-order {
            font-weight: 600;
            color: #e53e3e;
            font-size: 16px;
        }
        
        .issue-date {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .issue-description {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #fed7d7;
        }
        
        .issue-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #7f8c8d;
            flex-wrap: wrap;
            gap: 10px;
        }

        .issue-order-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .issue-order-btn:hover {
            background: #2980b9;
        }

        /* Счетчики проблем */
        .issues-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .issue-stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #e74c3c;
        }
        
        .issue-stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 5px;
        }
        
        .issue-stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .report-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .info-row {
                flex-direction: column;
                gap: 5px;
            }
            
            .info-label {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Проверка авторизации -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('userProfile') || sessionStorage.getItem('userProfile');
            if (!userData) {
                window.location.href = 'auth.html';
                return;
            }
            loadReports();
        });
    </script>

    <div class="container">
        <a href="mobile_order_dashboard.html" class="back-btn">
            ← Вернуться к дашборду
        </a>
        
        <div class="header">
            <h1>📊 Отчеты по заказам</h1>
            <p>Детальная информация о движении заказов по производственным участкам</p>
        </div>

        <!-- Поиск по отчетам -->
        <div class="search-container">
            <div class="search-input-container">
                <input type="text" id="searchInput" class="search-input" placeholder="🔍 Поиск в отчетах по номеру заказа, клиенту или проблеме...">
                <button class="clear-search" id="clearSearch" onclick="clearSearch()">×</button>
                <span class="search-icon">🔍</span>
            </div>
        </div>

        <!-- Вкладки отчетов -->
        <div class="report-tabs">
            <button class="report-tab active" onclick="showReportTab('orders')">📊 Все заказы</button>
            <button class="report-tab" onclick="showReportTab('issues')">⚠️ Проблемы</button>
            <button class="report-tab" onclick="showReportTab('analytics')">📈 Аналитика</button>
        </div>

        <!-- Общая статистика -->
        <div class="stats-overview" id="statsOverview"></div>

        <!-- Раздел заказов -->
        <div id="ordersSection" class="report-section">
            <div class="reports-grid" id="reportsContainer"></div>
        </div>

        <!-- Раздел проблем -->
        <div id="issuesSection" class="report-section" style="display: none;">
            <div class="issues-stats" id="issuesStats"></div>
            <div class="issues-section" id="issuesContainer"></div>
        </div>

        <!-- Раздел аналитики -->
        <div id="analyticsSection" class="report-section" style="display: none;">
            <div id="analyticsContainer"></div>
        </div>
    </div>

    <script>
        // Производственные участки
        const SECTIONS = {
            cutting: { name: 'Резка', icon: '🔪', order: 1 },
            cleaning: { name: 'Зачистка/Травление', icon: '🧹', order: 2 },
            welding: { name: 'Сварка', icon: '⚡', order: 3 },
            painting: { name: 'Покраска', icon: '🎨', order: 4 },
            warehouse: { name: 'Склад', icon: '📦', order: 5 },
            shipped: { name: 'Отгружено', icon: '🚛', order: 6 }
        };

        // Глобальные переменные
        let searchFilter = '';
        let currentTab = 'orders';
        let allOrders = [];

        // Получение заказов из localStorage
        function getOrdersFromStorage() {
            const ordersData = localStorage.getItem('ordersData');
            return ordersData ? JSON.parse(ordersData) : [];
        }

        // Расчет прогресса заказа
        function calculateOrderProgress(order) {
            if (!order.currentSection) return 0;
            
            const sectionOrder = SECTIONS[order.currentSection].order;
            const totalSections = Object.keys(SECTIONS).length;
            
            return Math.round((sectionOrder / totalSections) * 100);
        }

        // Форматирование даты
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Форматирование времени
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Загрузка отчетов
        function loadReports() {
            allOrders = getOrdersFromStorage();
            
            // Инициализируем поиск
            initializeSearch();
            
            // Показываем статистику
            showStatistics(allOrders);
            
            // Показываем текущую вкладку
            showCurrentTab();
        }

        // === СИСТЕМА ПОИСКА ===
        
        // Инициализация поиска
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearch');
            
            searchInput.addEventListener('input', function(e) {
                searchFilter = e.target.value.toLowerCase().trim();
                
                // Показываем/скрываем кнопку очистки
                if (searchFilter) {
                    clearBtn.style.display = 'flex';
                } else {
                    clearBtn.style.display = 'none';
                }
                
                // Обновляем текущую вкладку с фильтром
                showCurrentTab();
            });
        }
        
        // Очистка поиска
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearch');
            
            searchInput.value = '';
            searchFilter = '';
            clearBtn.style.display = 'none';
            
            // Обновляем текущую вкладку
            showCurrentTab();
        }
        
        // === УПРАВЛЕНИЕ ВКЛАДКАМИ ===
        
        // Переключение вкладок
        function showReportTab(tabName) {
            console.log('Переключение на вкладку:', tabName);
            
            // Убираем активный класс с табов
            document.querySelectorAll('.report-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Скрываем все секции
            document.querySelectorAll('.report-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Показываем выбранную вкладку
            const targetTab = document.querySelector(`[onclick="showReportTab('${tabName}')"]`);
            const targetSection = document.getElementById(tabName + 'Section');
            
            console.log('Найдена вкладка:', targetTab);
            console.log('Найдена секция:', targetSection);
            
            if (targetTab) targetTab.classList.add('active');
            if (targetSection) targetSection.style.display = 'block';
            
            currentTab = tabName;
            showCurrentTab();
        }
        
        // Показ текущей вкладки
        function showCurrentTab() {
            const filteredOrders = filterOrders(allOrders);
            
            switch (currentTab) {
                case 'orders':
                    showOrderReports(filteredOrders);
                    break;
                case 'issues':
                    showIssuesReports(filteredOrders);
                    break;
                case 'analytics':
                    showAnalytics(filteredOrders);
                    break;
            }
        }
        
        // Фильтрация заказов
        function filterOrders(orders) {
            if (!searchFilter) {
                return orders;
            }
            
            return orders.filter(order => {
                // Поиск по основным полям заказа
                const orderFields = [
                    order.number,
                    order.client || order.manager,
                    order.product || order.operationType,
                    SECTIONS[order.currentSection]?.name || 'Новый заказ'
                ].join(' ').toLowerCase();
                
                // Поиск по проблемам
                const issueFields = order.issues ? 
                    order.issues.map(issue => issue.description).join(' ').toLowerCase() : '';
                
                return orderFields.includes(searchFilter) || issueFields.includes(searchFilter);
            });
        }

        // Показ общей статистики
        function showStatistics(orders) {
            const stats = {
                total: orders.length,
                inProgress: orders.filter(o => o.currentSection && o.currentSection !== 'shipped').length,
                completed: orders.filter(o => o.currentSection === 'shipped').length,
                new: orders.filter(o => !o.currentSection).length
            };

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Всего заказов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚙️</div>
                    <div class="stat-number">${stats.inProgress}</div>
                    <div class="stat-label">В производстве</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">✅</div>
                    <div class="stat-number">${stats.completed}</div>
                    <div class="stat-label">Отгружено</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📋</div>
                    <div class="stat-number">${stats.new}</div>
                    <div class="stat-label">Новые заказы</div>
                </div>
            `;

            document.getElementById('statsOverview').innerHTML = statsHTML;
        }

        // Показ отчетов по заказам
        function showOrderReports(orders) {
            const reportsContainer = document.getElementById('reportsContainer');
            
            if (orders.length === 0) {
                const emptyText = searchFilter ? 
                    'По вашему запросу заказы не найдены' : 
                    'Нет заказов для отчета';
                const emptySubtext = searchFilter ? 
                    'Попробуйте изменить поисковый запрос' : 
                    'Создайте первый заказ в дашборде';
                    
                reportsContainer.innerHTML = `
                    <div class="empty-reports">
                        <div class="icon">📋</div>
                        <div class="text">${emptyText}</div>
                        <div class="subtext">${emptySubtext}</div>
                    </div>
                `;
                return;
            }

            let reportsHTML = '';
            
            orders.forEach(order => {
                const progress = calculateOrderProgress(order);
                const currentSectionName = order.currentSection ? SECTIONS[order.currentSection].name : 'Новый заказ';
                const issuesCount = order.issues ? order.issues.length : 0;
                const issuesBadge = issuesCount > 0 ? `<span style="color: #e74c3c; font-weight: bold; margin-left: 10px;">⚠️ ${issuesCount} проблем(ы)</span>` : '';
                
                reportsHTML += `
                    <div class="report-card">
                        <div class="report-header">
                            <div class="order-title">
                                📦 ${order.number} - ${order.product || order.operationType}${issuesBadge}
                            </div>
                            <div class="order-date">${formatDate(order.date)}</div>
                        </div>
                        
                        <div class="order-info">
                            <div class="info-row">
                                <span class="info-label">Клиент:</span>
                                <span class="info-value">${order.client || order.manager}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Товар:</span>
                                <span class="info-value">${order.product || order.operationType}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Дата заказа:</span>
                                <span class="info-value">${formatDate(order.date)}</span>
                            </div>
                        </div>
                        
                        <div class="current-status">
                            <div class="status-title">Текущий участок: ${currentSectionName}</div>
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div class="progress-text">${progress}% завершено</div>
                            </div>
                        </div>
                        
                        <div class="logistics-chain">
                            <div class="chain-title">
                                🔄 Цепочка логистики
                            </div>
                            ${generateLogisticsChain(order)}
                        </div>
                        
                        ${issuesCount > 0 ? generateIssuesPreview(order.issues) : ''}
                    </div>
                `;
            });
            
            reportsContainer.innerHTML = reportsHTML;
        }
        
        // === ОТЧЕТЫ ПО ПРОБЛЕМАМ ===
        
        // Показ отчетов по проблемам
        function showIssuesReports(orders) {
            console.log('Показ проблем. Всего заказов:', orders.length);
            
            // Собираем все проблемы
            const allIssues = [];
            orders.forEach(order => {
                console.log('Проверяем заказ:', order.number, 'Проблемы:', order.issues);
                if (order.issues && order.issues.length > 0) {
                    order.issues.forEach(issue => {
                        allIssues.push({
                            ...issue,
                            orderNumber: order.number,
                            orderProduct: order.product || order.operationType,
                            orderClient: order.client || order.manager
                        });
                    });
                }
            });
            
            console.log('Найдено проблем:', allIssues.length);
            
            // Показываем статистику проблем
            showIssuesStatistics(allIssues);
            
            // Показываем список проблем
            const issuesContainer = document.getElementById('issuesContainer');
            
            if (allIssues.length === 0) {
                const emptyText = searchFilter ? 
                    'По вашему запросу проблемы не найдены' : 
                    'Проблем не найдено';
                const emptySubtext = searchFilter ? 
                    'Попробуйте изменить поисковый запрос' : 
                    'Все заказы выполняются без проблем';
                    
                issuesContainer.innerHTML = `
                    <div class="empty-reports">
                        <div class="icon">✅</div>
                        <div class="text">${emptyText}</div>
                        <div class="subtext">${emptySubtext}</div>
                    </div>
                `;
                return;
            }
            
            // Сортируем проблемы по дате (новые сверху)
            allIssues.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let issuesHTML = '';
            allIssues.forEach(issue => {
                issuesHTML += `
                    <div class="issue-item">
                        <div class="issue-header">
                            <div class="issue-order">⚠️ Заказ ${issue.orderNumber}</div>
                            <div class="issue-date">${formatDateTime(issue.timestamp)}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px; color: #7f8c8d; font-size: 14px;">
                            <strong>Клиент:</strong> ${issue.orderClient} | <strong>Товар:</strong> ${issue.orderProduct}
                        </div>
                        
                        <div class="issue-description">
                            ${issue.description}
                        </div>
                        
                        <div class="issue-meta">
                            <span>Автор: ${issue.user}</span>
                            <span>${issue.resolved ? '✅ Решено' : '🔄 В работе'}</span>
                            <button class="issue-order-btn" onclick="goToOrder('${issue.orderNumber}')">
                                📋 Перейти к заказу
                            </button>
                        </div>
                    </div>
                `;
            });
            
            issuesContainer.innerHTML = issuesHTML;
        }
        
        // Показ статистики проблем
        function showIssuesStatistics(issues) {
            const activeIssues = issues.filter(issue => !issue.resolved);
            const resolvedIssues = issues.filter(issue => issue.resolved);
            
            const statsHTML = `
                <div class="issue-stat-card">
                    <div class="issue-stat-number">${issues.length}</div>
                    <div class="issue-stat-label">Всего проблем</div>
                </div>
                <div class="issue-stat-card">
                    <div class="issue-stat-number">${activeIssues.length}</div>
                    <div class="issue-stat-label">Активных</div>
                </div>
                <div class="issue-stat-card">
                    <div class="issue-stat-number">${resolvedIssues.length}</div>
                    <div class="issue-stat-label">Решенных</div>
                </div>
            `;
            
            document.getElementById('issuesStats').innerHTML = statsHTML;
        }
        
        // Генерация превью проблем для карточки заказа
        function generateIssuesPreview(issues) {
            if (!issues || issues.length === 0) return '';
            
            const activeIssues = issues.filter(issue => !issue.resolved);
            const recentIssue = issues[issues.length - 1];
            
            return `
                <div style="margin-top: 20px; padding: 15px; background: #fff5f5; border-radius: 8px; border-left: 4px solid #e74c3c;">
                    <div style="font-weight: 600; color: #e74c3c; margin-bottom: 8px;">
                        ⚠️ Последняя проблема (${formatDateTime(recentIssue.timestamp)})
                    </div>
                    <div style="font-size: 14px; color: #2c3e50;">
                        ${recentIssue.description.substring(0, 100)}${recentIssue.description.length > 100 ? '...' : ''}
                    </div>
                    ${activeIssues.length > 0 ? `<div style="font-size: 12px; color: #e74c3c; margin-top: 5px;">🔄 ${activeIssues.length} активных проблем</div>` : ''}
                </div>
            `;
        }
        
        // === АНАЛИТИКА ===
        
        // Показ аналитики
        function showAnalytics(orders) {
            const analyticsContainer = document.getElementById('analyticsContainer');
            
            // Подсчет статистики
            const stats = {
                total: orders.length,
                inProgress: orders.filter(o => o.currentSection && o.currentSection !== 'shipped').length,
                completed: orders.filter(o => o.currentSection === 'shipped').length,
                new: orders.filter(o => !o.currentSection).length,
                withIssues: orders.filter(o => o.issues && o.issues.length > 0).length
            };
            
            // Статистика по участкам
            const sectionStats = {};
            Object.keys(SECTIONS).forEach(section => {
                sectionStats[section] = orders.filter(o => o.currentSection === section).length;
            });
            
            let analyticsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">Всего заказов</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">⚙️</div>
                        <div class="stat-number">${stats.inProgress}</div>
                        <div class="stat-label">В производстве</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">✅</div>
                        <div class="stat-number">${stats.completed}</div>
                        <div class="stat-label">Отгружено</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">⚠️</div>
                        <div class="stat-number">${stats.withIssues}</div>
                        <div class="stat-label">С проблемами</div>
                    </div>
                </div>
                
                <div class="report-card">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Заказы по участкам</h3>
            `;
            
            Object.keys(SECTIONS).forEach(sectionKey => {
                const section = SECTIONS[sectionKey];
                const count = sectionStats[sectionKey];
                const percentage = stats.total > 0 ? Math.round((count / stats.total) * 100) : 0;
                
                analyticsHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span>${section.icon} ${section.name}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 100px; height: 8px; background: #ecf0f1; border-radius: 4px;">
                                <div style="width: ${percentage}%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px;"></div>
                            </div>
                            <span style="font-weight: bold; min-width: 30px;">${count}</span>
                        </div>
                    </div>
                `;
            });
            
            analyticsHTML += '</div>';
            
            // Добавляем тренды если есть данные
            if (orders.length > 0) {
                analyticsHTML += generateTrendsAnalysis(orders);
            }
            
            analyticsContainer.innerHTML = analyticsHTML;
        }
        
        // Генерация анализа трендов
        function generateTrendsAnalysis(orders) {
            const issuesCount = orders.reduce((total, order) => 
                total + (order.issues ? order.issues.length : 0), 0);
            
            const avgProgress = orders.length > 0 ? 
                Math.round(orders.reduce((total, order) => 
                    total + calculateOrderProgress(order), 0) / orders.length) : 0;
            
            return `
                <div class="report-card" style="margin-top: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">📈 Ключевые показатели</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">📊</div>
                            <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${avgProgress}%</div>
                            <div style="color: #7f8c8d;">Средний прогресс</div>
                        </div>
                        
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">⚠️</div>
                            <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${issuesCount}</div>
                            <div style="color: #7f8c8d;">Всего проблем</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Генерация цепочки логистики
        function generateLogisticsChain(order) {
            let chainHTML = '';
            const sectionKeys = Object.keys(SECTIONS);
            
            sectionKeys.forEach(sectionKey => {
                const section = SECTIONS[sectionKey];
                const historyItem = order.history.find(h => h.section === sectionKey);
                
                if (historyItem) {
                    const isCurrentSection = order.currentSection === sectionKey;
                    const className = isCurrentSection ? 'current' : 'completed';
                    const icon = isCurrentSection ? '🟡' : '✅';
                    const statusText = isCurrentSection ? ' - текущий' : '';
                    const timeText = formatDateTime(historyItem.timestamp);
                    
                    chainHTML += `
                        <div class="chain-item ${className}">
                            <span class="chain-icon">${icon}</span>
                            <span class="chain-text">Перемещен на ${section.name}${statusText}</span>
                            <span class="chain-time">${timeText}</span>
                        </div>
                    `;
                } else {
                    chainHTML += `
                        <div class="chain-item pending">
                            <span class="chain-icon">⚪</span>
                            <span class="chain-text">${section.name}</span>
                            <span class="chain-time">Ожидание</span>
                        </div>
                    `;
                }
            });
            
            return chainHTML;
        }

        // Переход к заказу с поиском
        function goToOrder(orderNumber) {
            // Открываем дашборд с поиском по номеру заказа
            const searchQuery = encodeURIComponent(orderNumber);
            window.location.href = `mobile_order_dashboard.html?search=${searchQuery}`;
        }
    </script>
</body>
</html>