<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #5a67d8;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <h1>üß™ –ü–∞–Ω–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã</h1>
    
    <div class="test-panel">
        <h3>üîê –¢–µ—Å—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
        <button class="btn" onclick="clearAuth()">–û—á–∏—Å—Ç–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
        <button class="btn" onclick="setTestUser()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <button class="btn" onclick="checkAuth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
        <div id="authStatus" class="status info">–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é"</div>
    </div>

    <div class="test-panel">
        <h3>üì¶ –¢–µ—Å—Ç—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</h3>
        <button class="btn" onclick="clearOrders()">–û—á–∏—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑—ã</button>
        <button class="btn" onclick="createTestOrders()">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</button>
        <button class="btn" onclick="loadFromCSV()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ CSV</button>
        <button class="btn" onclick="viewOrders()">–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫–∞–∑—ã</button>
        <div id="ordersStatus" class="status info">–ù–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫–∞–∑—ã"</div>
    </div>

    <div class="test-panel">
        <h3>üîÑ –¢–µ—Å—Ç—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π</h3>
        <button class="btn" onclick="testMoveOrder()">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ "–†–µ–∑–∫—É"</button>
        <button class="btn" onclick="testProgressCalculation()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        <div id="moveStatus" class="status info">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>
    </div>

    <div class="test-panel">
        <h3>üöÄ –ë—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã</h3>
        <button class="btn" onclick="goToAuth()">‚Üí –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</button>
        <button class="btn" onclick="goToDashboard()">‚Üí –î–∞—à–±–æ—Ä–¥</button>
        <button class="btn" onclick="goToReports()">‚Üí –û—Ç—á–µ—Ç—ã</button>
        <button class="btn" onclick="goToDemo()">‚Üí –î–µ–º–æ</button>
    </div>

    <script>
        // –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏
        const SECTIONS = {
            cutting: { name: '–†–µ–∑–∫–∞', icon: 'üî™', order: 1 },
            cleaning: { name: '–ó–∞—á–∏—Å—Ç–∫–∞/–¢—Ä–∞–≤–ª–µ–Ω–∏–µ', icon: 'üßπ', order: 2 },
            welding: { name: '–°–≤–∞—Ä–∫–∞', icon: '‚ö°', order: 3 },
            painting: { name: '–ü–æ–∫—Ä–∞—Å–∫–∞', icon: 'üé®', order: 4 },
            warehouse: { name: '–°–∫–ª–∞–¥', icon: 'üì¶', order: 5 },
            shipped: { name: '–û—Ç–≥—Ä—É–∂–µ–Ω–æ', icon: 'üöõ', order: 6 }
        };

        // –¢–µ—Å—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function clearAuth() {
            localStorage.removeItem('userProfile');
            sessionStorage.removeItem('userProfile');
            document.getElementById('authStatus').innerHTML = '‚úÖ –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—á–∏—â–µ–Ω—ã';
            document.getElementById('authStatus').className = 'status success';
        }

        function setTestUser() {
            const testUser = {
                firstName: '–¢–µ—Å—Ç',
                lastName: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                fullName: '–¢–µ—Å—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                loginTime: new Date().toISOString(),
                rememberMe: true
            };
            
            localStorage.setItem('userProfile', JSON.stringify(testUser));
            document.getElementById('authStatus').innerHTML = '‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω: ' + testUser.fullName;
            document.getElementById('authStatus').className = 'status success';
        }

        function checkAuth() {
            const userData = localStorage.getItem('userProfile') || sessionStorage.getItem('userProfile');
            const statusEl = document.getElementById('authStatus');
            
            if (userData) {
                const user = JSON.parse(userData);
                statusEl.innerHTML = '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ' + user.fullName + '<br>–í—Ä–µ–º—è –≤—Ö–æ–¥–∞: ' + new Date(user.loginTime).toLocaleString('ru-RU');
                statusEl.className = 'status success';
            } else {
                statusEl.innerHTML = '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                statusEl.className = 'status info';
            }
        }

        // –¢–µ—Å—Ç—ã –∑–∞–∫–∞–∑–æ–≤
        function clearOrders() {
            localStorage.removeItem('ordersData');
            document.getElementById('ordersStatus').innerHTML = '‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–æ–≤ –æ—á–∏—â–µ–Ω—ã';
            document.getElementById('ordersStatus').className = 'status success';
        }

        function createTestOrders() {
            const testOrders = [
                {
                    id: 'TEST001',
                    number: 'TEST-001',
                    client: '–û–û–û "–¢–µ—Å—Ç–ö–æ–º–ø–∞–Ω–∏—è"',
                    product: '–¢–µ—Å—Ç–æ–≤–∞—è –º–µ—Ç–∞–ª–ª–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è',
                    date: '2024-10-11',
                    currentSection: null,
                    progress: 0,
                    history: [
                        {
                            action: 'created',
                            section: null,
                            timestamp: new Date().toISOString(),
                            user: '–¢–µ—Å—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                        }
                    ]
                },
                {
                    id: 'TEST002',
                    number: 'TEST-002',
                    client: '–ò–ü –¢–µ—Å—Ç–æ–≤ –ê.–ê.',
                    product: '–¢–µ—Å—Ç–æ–≤—ã–µ –≤–æ—Ä–æ—Ç–∞',
                    date: '2024-10-11',
                    currentSection: 'cutting',
                    progress: 17,
                    history: [
                        {
                            action: 'created',
                            section: null,
                            timestamp: new Date(Date.now() - 3600000).toISOString(),
                            user: '–¢–µ—Å—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                        },
                        {
                            action: 'moved',
                            section: 'cutting',
                            sectionName: '–†–µ–∑–∫–∞',
                            timestamp: new Date().toISOString(),
                            user: '–¢–µ—Å—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                        }
                    ]
                }
            ];
            
            localStorage.setItem('ordersData', JSON.stringify(testOrders));
            document.getElementById('ordersStatus').innerHTML = '‚úÖ –°–æ–∑–¥–∞–Ω–æ ' + testOrders.length + ' —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞';
            document.getElementById('ordersStatus').className = 'status success';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV —Ñ–∞–π–ª–∞
        async function loadFromCSV() {
            const statusEl = document.getElementById('ordersStatus');
            statusEl.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV...';
            statusEl.className = 'status info';
            
            try {
                const response = await fetch('./orders_data.csv');
                if (!response.ok) {
                    throw new Error('–§–∞–π–ª CSV –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                
                const csvText = await response.text();
                const parsedOrders = parseCSVData(csvText);
                
                if (parsedOrders.length > 0) {
                    localStorage.setItem('ordersData', JSON.stringify(parsedOrders));
                    statusEl.innerHTML = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${parsedOrders.length} –∑–∞–∫–∞–∑–æ–≤ –∏–∑ CSV —Ñ–∞–π–ª–∞`;
                    statusEl.className = 'status success';
                } else {
                    statusEl.innerHTML = '‚ö†Ô∏è CSV —Ñ–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
                    statusEl.className = 'status error';
                }
            } catch (error) {
                statusEl.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV: ${error.message}`;
                statusEl.className = 'status error';
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ CSV –¥–∞–Ω–Ω—ã—Ö (–∫–æ–ø–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –¥–∞—à–±–æ—Ä–¥–∞)
        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const orders = [];
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø–µ—Ä–≤—ã–µ 9 —Å—Ç—Ä–æ–∫)
            for (let i = 9; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = parseCSVLine(line);
                if (columns.length < 17) continue;
                
                const order = parseOrderFromCSV(columns);
                if (order && order.number) {
                    orders.push(order);
                }
            }
            
            return orders;
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ CSV
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–∫–∞–∑–∞ –∏–∑ CSV —Å—Ç—Ä–æ–∫–∏
        function parseOrderFromCSV(columns) {
            const shipmentStatus = columns[1] || '';
            const manager = columns[2] || '';
            const orderNumber = columns[3] || '';
            const operationType = columns[4] || '';
            const shipmentDate = columns[5] || '';
            
            if (!orderNumber || orderNumber.includes('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è') || orderNumber.includes('–ü—Ä–æ—Å—Ç–æ–π')) {
                return null;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—á–∞—Å—Ç–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
            let currentSection = null;
            let progress = 0;
            
            if (shipmentStatus === '–û—Ç–≥—Ä—É–∂–µ–Ω–æ') {
                currentSection = 'shipped';
                progress = 100;
            } else if (shipmentStatus === '–ì–æ—Ç–æ–≤–æ') {
                currentSection = 'warehouse';
                progress = 85;
            } else {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—á–∞—Å—Ç–æ–∫ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º
                if (operationType.includes('–†')) currentSection = 'cutting';
                else if (operationType.includes('–ü–ö') || operationType.includes('–ü–∫')) currentSection = 'painting';
                else if (operationType.includes('–°–≤')) currentSection = 'welding';
                else if (operationType.includes('–ì')) currentSection = 'cleaning';
                else currentSection = null;
                
                progress = currentSection ? calculateProgressBySection(currentSection) : 0;
            }

            const order = {
                id: `CSV_${orderNumber.replace(/[^a-zA-Z0-9]/g, '_')}`,
                number: orderNumber,
                client: manager,
                product: operationType,
                date: shipmentDate || new Date().toISOString().split('T')[0],
                currentSection: currentSection,
                progress: progress,
                history: [{
                    action: 'created',
                    section: currentSection,
                    sectionName: currentSection ? SECTIONS[currentSection].name : '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑',
                    timestamp: new Date().toISOString(),
                    user: '–°–∏—Å—Ç–µ–º–∞'
                }],
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                manager: manager,
                operationType: operationType,
                shipmentDate: shipmentDate,
                shipmentStatus: shipmentStatus,
                priority: getPriorityFromOperationType(operationType)
            };

            return order;
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü–∏–π
        function getPriorityFromOperationType(operationType) {
            if (!operationType) return 'medium';
            
            // –°–ª–æ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ = –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
            if (operationType.includes('–°–≤') && operationType.includes('–ü–∫')) return 'high';
            if (operationType.length > 3) return 'high';
            
            // –ü—Ä–æ—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ = –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
            if (operationType === '–†' || operationType === '–ì') return 'low';
            
            return 'medium';
        }

        // –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ —É—á–∞—Å—Ç–∫—É
        function calculateProgressBySection(section) {
            const progressMap = {
                cutting: 17,      // 1/6 * 100
                cleaning: 33,     // 2/6 * 100
                welding: 50,      // 3/6 * 100
                painting: 67,     // 4/6 * 100
                warehouse: 85,    // 5/6 * 100
                shipped: 100      // 6/6 * 100
            };
            return progressMap[section] || 0;
        }

        function viewOrders() {
            const ordersData = localStorage.getItem('ordersData');
            const statusEl = document.getElementById('ordersStatus');
            
            if (ordersData) {
                const orders = JSON.parse(ordersData);
                let info = `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${orders.length} –∑–∞–∫–∞–∑–æ–≤:<br>`;
                
                orders.forEach(order => {
                    const currentSection = order.currentSection ? SECTIONS[order.currentSection].name : '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑';
                    info += `‚Ä¢ ${order.number} - ${order.product} (${currentSection}, ${order.progress}%)<br>`;
                });
                
                statusEl.innerHTML = info;
                statusEl.className = 'status success';
            } else {
                statusEl.innerHTML = '‚ùå –ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                statusEl.className = 'status info';
            }
        }

        // –¢–µ—Å—Ç—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
        function testMoveOrder() {
            const ordersData = localStorage.getItem('ordersData');
            const statusEl = document.getElementById('moveStatus');
            
            if (!ordersData) {
                statusEl.innerHTML = '‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã';
                statusEl.className = 'status info';
                return;
            }
            
            const orders = JSON.parse(ordersData);
            const order = orders.find(o => !o.currentSection);
            
            if (!order) {
                statusEl.innerHTML = '‚ùå –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (–≤—Å–µ —É–∂–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã)';
                statusEl.className = 'status info';
                return;
            }
            
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∑–∞–∫–∞–∑ –Ω–∞ —Ä–µ–∑–∫—É
            order.currentSection = 'cutting';
            order.progress = Math.round((SECTIONS.cutting.order / Object.keys(SECTIONS).length) * 100);
            order.history.push({
                action: 'moved',
                section: 'cutting',
                sectionName: '–†–µ–∑–∫–∞',
                timestamp: new Date().toISOString(),
                user: '–¢–µ—Å—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
            });
            
            localStorage.setItem('ordersData', JSON.stringify(orders));
            
            statusEl.innerHTML = `‚úÖ –ó–∞–∫–∞–∑ ${order.number} –ø–µ—Ä–µ–º–µ—â–µ–Ω –Ω–∞ "–†–µ–∑–∫–∞" (${order.progress}% –ø—Ä–æ–≥—Ä–µ—Å—Å–∞)`;
            statusEl.className = 'status success';
        }

        function testProgressCalculation() {
            const statusEl = document.getElementById('moveStatus');
            let info = '‚úÖ –¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:<br>';
            
            Object.keys(SECTIONS).forEach(sectionKey => {
                const section = SECTIONS[sectionKey];
                const progress = Math.round((section.order / Object.keys(SECTIONS).length) * 100);
                info += `‚Ä¢ ${section.name}: ${progress}%<br>`;
            });
            
            statusEl.innerHTML = info;
            statusEl.className = 'status success';
        }

        // –ë—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
        function goToAuth() {
            window.open('auth.html', '_blank');
        }

        function goToDashboard() {
            window.open('mobile_order_dashboard.html', '_blank');
        }

        function goToReports() {
            window.open('reports.html', '_blank');
        }

        function goToDemo() {
            window.open('full_app_demo.html', '_blank');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            viewOrders();
        });
    </script>
</body>
</html>